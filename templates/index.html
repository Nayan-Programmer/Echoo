<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EchooAI - AI Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
* {margin:0;padding:0;box-sizing:border-box;}
body {font-family:'Inter', system-ui, sans-serif;color:#fff;background:#000;overflow-x:hidden;}
:root {
    --primary-500:hsl(172.4, 82.8%, 36.1%);
    --emerald-500:hsl(160, 84.1%, 39.4%);
    --glass-bg:rgba(255,255,255,0.08);
    --glass-dark-bg:rgba(30,41,59,0.9);
    --glass-dark-border:rgba(148,163,184,0.15);
    --radius:1.3rem;
}

/* Background */
.background-gradient {position:fixed;inset:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);opacity:0.9;z-index:-2;}
.background-overlay {position:fixed;inset:0;background-image:url('https://images.unsplash.com/photo-1635070041078-e363dbe005cb?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&h=1080');background-size:cover;background-position:center;opacity:0.05;z-index:-1;}

/* App layout */
.app {min-height:100vh;display:flex;flex-direction:column;}
.header {background:var(--glass-dark-bg);backdrop-filter:blur(15px);border-bottom:1px solid var(--glass-dark-border);}
.header-content {max-width:1536px;margin:0 auto;padding:0 1.5rem;display:flex;align-items:center;justify-content:space-between;height:4rem;}
.logo-section {display:flex;align-items:center;gap:.75rem;}
.logo-icon {width:2rem;height:2rem;border-radius:var(--radius);background:linear-gradient(135deg,var(--primary-500) 0%,var(--emerald-500) 100%);display:flex;align-items:center;justify-content:center;}
.logo-img {width:1rem;height:1rem;border-radius:.25rem;}
.logo-text h1 {font-size:1.5rem;font-weight:700;color:white;margin:0;}
.header-btn {padding:.6rem 1rem;border-radius:.5rem;background:var(--glass-bg);border:1px solid var(--glass-dark-border);color:white;cursor:pointer;}
.header-btn:hover {background:rgba(255,255,255,0.15);}

/* Main content */
.main-content {flex:1;display:flex;max-width:80rem;margin:0 auto;width:100%;padding:1.5rem;gap:1.5rem;}
.welcome-screen {flex:1;display:flex;align-items:center;justify-content:center;}
.welcome-content {text-align:center;max-width:32rem;margin:0 auto;}
.welcome-logo {width:5rem;height:5rem;margin:0 auto 2rem;background:linear-gradient(135deg,var(--primary-500) 0%,var(--emerald-500) 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;}
.welcome-logo-img {width:2rem;height:2rem;}
.welcome-title {font-size:2.5rem;font-weight:700;color:white;margin-bottom:1rem;}
.welcome-description {font-size:1.2rem;color:#d1d5db;margin-bottom:2rem;}
.start-chat-btn {padding:1rem 2rem;background:linear-gradient(135deg,var(--primary-500) 0%,var(--emerald-500) 100%);color:white;font-weight:600;border:none;border-radius:var(--radius);cursor:pointer;}
.start-chat-btn:hover {transform:scale(1.05);}

/* Sidebar */
.sidebar {width:20rem;background:var(--glass-dark-bg);border:1px solid var(--glass-dark-border);border-radius:1rem;padding:1.5rem;display:none;flex-direction:column;}
.sidebar-heading {font-size:1.25rem;font-weight:600;margin-bottom:1rem;}
.sidebar-item {padding:.75rem 1rem;border-radius:.75rem;background:rgba(255,255,255,0.05);color:#d1d5db;cursor:pointer;margin-bottom:.5rem;}
.sidebar-item:hover, .sidebar-item.active {background:rgba(255,255,255,0.12);color:white;}

/* Chat area */
.chat-area {flex:1;display:none;flex-direction:column;}
.messages-container {flex:1;background:var(--glass-dark-bg);border:1px solid var(--glass-dark-border);border-radius:1rem;padding:1.5rem;margin-bottom:1.5rem;overflow-y:auto;}
.message {display:flex;margin-bottom:1rem;}
.message.user {justify-content:flex-end;}
.message-content {max-width:70%;display:flex;align-items:flex-start;gap:.75rem;}
.message.user .message-content {flex-direction:row-reverse;}
.ai-avatar,.user-avatar {width:2rem;height:2rem;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;color:white;}
.ai-avatar {background:linear-gradient(135deg,var(--primary-500) 0%,var(--emerald-500) 100%);}
.user-avatar {background:linear-gradient(135deg,#8b5cf6 0%,#ec4899 100%);}
.message-bubble {border-radius:1rem;padding:.75rem 1rem;word-break:break-word;}
.message-bubble.ai {background:rgba(248,250,252,0.95);color:#374151;}
.message-bubble.user {background:linear-gradient(135deg,var(--primary-500) 0%,var(--emerald-500) 100%);color:white;}
.message-text {white-space:pre-wrap;line-height:1.4;}
img {max-width:100%;border-radius:8px;}

/* Input wrapper */
.message-input-wrapper {background:var(--glass-dark-bg);border:1px solid var(--glass-dark-border);border-radius:1rem;padding:.8rem;margin-top:.5rem;display:flex;gap:.5rem;}
#messageInput,#imagePrompt {flex:1;background:rgba(255,255,255,0.1);border:none;border-radius:var(--radius);padding:.75rem;color:white;}
.send-btn {background:linear-gradient(135deg,var(--primary-500) 0%,var(--emerald-500) 100%);border:none;border-radius:var(--radius);padding:.75rem 1rem;color:white;cursor:pointer;}
</style>
</head>
<body>
<div class="app">
    <div class="background-gradient"></div>
    <div class="background-overlay"></div>

    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon">
                    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo-img">
                </div>
                <div class="logo-text"><h1>EchooAI</h1></div>
            </div>
            <div class="header-actions">
                {% if user_info %}
                    <button class="header-btn" onclick="window.location.href='/logout'">Logout</button>
                {% else %}
                    <button class="header-btn" onclick="window.location.href='/google-login'">Sign in</button>
                {% endif %}
            </div>
        </div>
    </header>

    <main class="main-content">
        <!-- Welcome -->
        <div class="welcome-screen" id="welcomeScreen">
            <div class="welcome-content">
                <div class="welcome-logo">
                    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="welcome-logo-img">
                </div>
                {% if user_info %}
                    <h2 class="welcome-title">Welcome, {{ user_info.get('name', 'User') }} ðŸ‘‹</h2>
                    <button class="start-chat-btn" onclick="startChat()">Start Chat</button>
                {% else %}
                    <h2 class="welcome-title">Welcome to EchooAI</h2>
                    <p class="welcome-description">Sign in to start chatting.</p>
                    <button class="start-chat-btn" onclick="window.location.href='/google-login'">Sign in</button>
                {% endif %}
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <h3 class="sidebar-heading">Previous Chats</h3>
            <div class="sidebar-list" id="chatList">
                {% for chat in chat_sessions %}
                    <div class="sidebar-item" onclick="loadChat('{{ chat.id }}')" id="chat-{{ chat.id }}">{{ chat.title }}</div>
                {% endfor %}
            </div>
        </div>

        <!-- Chat -->
        <div class="chat-area" id="chatArea">
            <div class="messages-container" id="messagesContainer"></div>
            <div class="message-input-wrapper">
                <textarea id="messageInput" placeholder="Type your message..."></textarea>
                <button class="send-btn" onclick="sendMessage()">Send</button>
            </div>
            <div class="message-input-wrapper">
                <input id="imagePrompt" placeholder="Enter image prompt..."/>
                <button class="send-btn" onclick="generateImage()">Generate</button>
            </div>
        </div>
    </main>
</div>

<script>
// Show chat
function startChat(){
    document.getElementById('welcomeScreen').style.display='none';
    document.getElementById('sidebar').style.display='flex';
    document.getElementById('chatArea').style.display='flex';
}

// Append message
function appendMessage(sender,text){
    const c=document.getElementById('messagesContainer');
    const div=document.createElement('div');
    div.className='message '+(sender==='user'?'user':'ai');
    div.innerHTML=`<div class="message-content">
        <div class="${sender==='user'?'user-avatar':'ai-avatar'}">${sender==='user'?'U':'AI'}</div>
        <div class="message-bubble ${sender==='user'?'user':'ai'}"><div class="message-text">${text}</div></div>
    </div>`;
    c.appendChild(div);c.scrollTop=c.scrollHeight;
}

// Send message
async function sendMessage(){
    const t=document.getElementById('messageInput');
    const text=t.value.trim();if(!text) return;t.value='';
    appendMessage("user",text);
    try{
        const r=await fetch("/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:text})});
        const d=await r.json();appendMessage("ai",d.reply);
    }catch{appendMessage("ai","Error contacting AI server.");}
}

// Generate image
async function generateImage(){
    const p=document.getElementById("imagePrompt").value.trim();if(!p) return;
    appendMessage("user","[Image Prompt] "+p);
    try{
        const r=await fetch("/image-gen",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:p})});
        const d=await r.json();
        if(d.images){d.images.forEach(url=>appendMessage("ai",`<img src="${url}" style="max-width:200px;">`));}
        else appendMessage("ai","Image generation failed.");
    }catch{appendMessage("ai","Error contacting image API.");}
}

// Load chat from sidebar
function loadChat(id){
    window.location.href="/?active_chat="+id;
}

// Fix for undefined error
const activeChatId = "{{ active_chat|default('') }}";
const chatSessions = {{ chat_sessions|default([])|tojson }};
</script>
</body>
</html>
