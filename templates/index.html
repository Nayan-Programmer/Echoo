<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EchooAI - AI Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    /* ... (Existing CSS code, no changes needed unless you want to style the new sidebar) ... */
    /* Add this CSS for the sidebar and menu toggle */
    body {
        display: flex; /* This is a major change */
    }
    .sidebar {
        width: 250px;
        background: var(--glass-dark-bg);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-right: 1px solid var(--glass-dark-border);
        color: #fff;
        display: flex;
        flex-direction: column;
        padding: 1.5rem;
        transition: transform 0.3s ease-in-out;
    }
    .sidebar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    .sidebar-header .logo-text h1 {
        font-size: 1.5rem;
    }
    .sidebar-toggle {
        display: none;
        background: transparent;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
    }
    .sidebar-menu-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        border-radius: 0.75rem;
        color: #d1d5db;
        text-decoration: none;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    .sidebar-menu-item:hover, .sidebar-menu-item.active {
        background: rgba(255, 255, 255, 0.1);
        color: white;
    }
    .new-chat-btn {
        width: 100%;
        margin-bottom: 1rem;
    }
    .main-content {
        flex: 1; /* Make main content fill remaining space */
        display: flex;
        flex-direction: column;
        max-width: none;
        width: auto;
        padding: 0;
    }
    .header {
        flex-shrink: 0; /* Prevent header from shrinking */
    }
    .chat-area {
        flex: 1;
        display: none;
        flex-direction: column;
        max-width: 64rem;
        margin: 0 auto;
        width: 100%;
        padding: 1.5rem;
        gap: 1.5rem;
    }
    @media (max-width: 768px) {
        body {
            flex-direction: column;
        }
        .sidebar {
            width: 100%;
            height: auto;
            transform: translateX(-100%);
            position: absolute;
            z-index: 200;
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .sidebar-toggle {
            display: block;
        }
        .main-content {
            width: 100%;
            padding-top: 4rem; /* Adjust for fixed header */
        }
    }
</style>
</head>
<body>
<div class="background-gradient"></div>
<div class="background-overlay"></div>

<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="logo-section">
            <div class="logo-icon">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo-img">
            </div>
            <div class="logo-text">
                <h1>EchooAI</h1>
            </div>
        </div>
        <button class="sidebar-toggle" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
    </div>
    {% if user_info %}
    <a href="#" class="sidebar-menu-item new-chat-btn" onclick="startNewChat()">
        <i class="fas fa-plus"></i> New Chat
    </a>
    <nav class="sidebar-menu">
        {% for chat in previous_chats %}
        <a href="#" class="sidebar-menu-item" onclick="loadChat({{ chat.id }})">
            <i class="fas fa-comment"></i> {{ chat.chat_title }}
        </a>
        {% endfor %}
    </nav>
    {% endif %}
</aside>

<div class="app">
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon">
                    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo-img">
                </div>
                <div class="logo-text">
                    <h1>EchooAI</h1>
                </div>
            </div>
            <div class="header-actions">
                {% if user_info %}
                    <button class="header-btn" onclick="window.location.href='/logout'">Logout</button>
                {% else %}
                    <button class="header-btn" onclick="window.location.href='/google-login'">Sign in with Google</button>
                {% endif %}
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="welcome-screen" id="welcomeScreen">
            <div class="welcome-content">
                <div class="welcome-logo">
                    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="welcome-logo-img">
                </div>
                {% if user_info %}
                    <h2 class="welcome-title">Welcome, {{ user_info.get('given_name', 'User') }}! ðŸ‘‹</h2>
                    <p class="welcome-description">You're logged in. Click below to start chatting with EchooAI!</p>
                    <button class="start-chat-btn" onclick="startChat()">Start Chat</button>
                {% else %}
                    <h2 class="welcome-title">Welcome to EchooAI</h2>
                    <p class="welcome-description">Please sign in with Google to start chatting.</p>
                    <button class="start-chat-btn" onclick="window.location.href='/google-login'">Sign in with Google</button>
                {% endif %}
            </div>
        </div>

        <div class="chat-area" id="chatArea" style="display:none;">
            <div class="messages-container" id="messagesContainer"></div>
            <div class="message-input-container">
                <div class="message-input-wrapper">
                    <div class="input-area">
                        <textarea id="messageInput" placeholder="Type your message..."></textarea>
                        <button class="send-btn" onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-left">
                <span>&copy; 2025 EchooAI</span>
                <div class="separator"></div>
                <a href="#" class="footer-link">Privacy</a>
            </div>
            <div class="footer-right">
                <div class="status-indicator"></div>
                <span class="status-text">Online</span>
            </div>
        </div>
    </footer>
</div>

<script>
    let currentChatId = null;

    function startChat(){
        document.getElementById('welcomeScreen').style.display='none';
        document.getElementById('chatArea').style.display='flex';
        //Agar koi chat id nahi hai to new chat create karo
        if (!currentChatId) {
            startNewChat();
        }
    }

    async function loadChat(chatId) {
        currentChatId = chatId;
        document.getElementById('welcomeScreen').style.display = 'none';
        document.getElementById('chatArea').style.display = 'flex';
        const container = document.getElementById('messagesContainer');
        container.innerHTML = ''; // Clear previous messages
        
        try {
            const response = await fetch(`/chat-history/${chatId}`);
            const data = await response.json();
            if (response.ok) {
                data.history.forEach(msg => {
                    addMessageToUI(msg.content, msg.role);
                });
                container.scrollTop = container.scrollHeight;
            } else {
                addMessageToUI(data.error || "Failed to load chat history.", "assistant");
            }
        } catch (error) {
            console.error(error);
            addMessageToUI("Error loading chat history.", "assistant");
        }
    }

    async function startNewChat() {
        try {
            const response = await fetch("/new-chat", { method: "POST" });
            const data = await response.json();
            if (response.ok) {
                currentChatId = data.chat_id;
                document.getElementById('messagesContainer').innerHTML = ''; // Clear existing chat
                data.history.forEach(msg => {
                    addMessageToUI(msg.content, msg.role);
                });
                // Optionally, reload the page to show the new chat in the sidebar
                window.location.reload();
            }
        } catch (error) {
            console.error("Error creating new chat:", error);
        }
    }

    function addMessageToUI(text, role){
        const container = document.getElementById('messagesContainer');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role === 'user' ? 'user' : 'ai'}`;
        const avatarText = role === 'user' ? 'U' : 'AI';
        const avatarClass = role === 'user' ? 'user-avatar' : 'ai-avatar';
        const bubbleClass = role === 'user' ? 'user' : 'ai';
        messageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-avatar ${avatarClass}">${avatarText}</div>
                <div class="message-bubble ${bubbleClass}"><div class="message-text">${text}</div></div>
            </div>`;
        container.appendChild(messageDiv);
        container.scrollTop=container.scrollHeight;
    }

    async function sendMessage(){
        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        if(!text) return;
        if (!currentChatId) {
            alert("Please start a new chat first!");
            return;
        }

        addMessageToUI(text, "user");
        input.value='';

        try{
            const response = await fetch("/chat", {
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({message:text, chat_id: currentChatId})
            });
            const data = await response.json();
            const aiText = data.reply;
            addMessageToUI(aiText, "assistant");
        } catch(err){
            console.error(err);
            addMessageToUI("Error contacting AI server.", "assistant");
        }
    }
</script>
</body>
</html>
