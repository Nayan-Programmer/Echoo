<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EchooAI - AI Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    /* Base styles and variables */
    * {margin:0;padding:0;box-sizing:border-box;}
    html, body, #app {height:100%;}
    body {
        font-family:'Inter', system-ui, sans-serif;
        color:#fff;
        background:#000;
        overflow: hidden;
    }
    :root {
        --primary-500:hsl(172.4, 82.8%, 36.1%);
        --emerald-500:hsl(160, 84.1%, 39.4%);
        --glass-bg:rgba(255,255,255,0.1);
        --glass-dark-bg:rgba(30,41,59,0.8);
        --glass-dark-border:rgba(148,163,184,0.1);
        --radius:1.3rem;
    }

    /* Background and Layout */
    .background-gradient {position:fixed;inset:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);opacity:0.9;z-index:-2;}
    .background-overlay {position:fixed;inset:0;background-color:rgba(0,0,0,0.6);z-index:-1;}
    #app {
        display:flex;
        flex-direction: column;
        height: 100vh;
        width: 100vw;
    }
    .main-layout {
        display:flex;
        flex:1;
        overflow:hidden;
    }

    /* Sidebar */
    .sidebar {
        width: 280px;
        background-color: var(--glass-dark-bg);
        border-right: 1px solid var(--glass-dark-border);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        padding:1rem;
        transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
        transform: translateX(0);
    }
    .sidebar.hidden {
        transform: translateX(-100%);
        width: 0;
        padding:0;
    }
    .chat-history {
        flex:1;
        overflow-y:auto;
        padding-top:1rem;
    }
    .chat-item {
        display: flex;
        align-items: center;
        padding:0.75rem 1rem;
        margin-bottom:0.5rem;
        border-radius: var(--radius);
        background: transparent;
        cursor: pointer;
        transition: background 0.2s ease, transform 0.2s ease;
        border:1px solid transparent;
    }
    .chat-item:hover, .chat-item.active {
        background: rgba(255,255,255,0.08);
    }
    .chat-item.active {
        border-color: var(--primary-500);
    }
    .chat-item-text {
        flex:1;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
        font-weight:500;
        font-size:0.9rem;
    }
    .new-chat-btn, .action-btn {
        width:100%;
        padding:0.75rem 1rem;
        margin-top:1rem;
        border:2px solid var(--primary-500);
        background: rgba(43, 108, 83, 0.4);
        color:white;
        border-radius:var(--radius);
        font-weight:600;
        cursor:pointer;
        transition: background 0.2s ease;
        font-size:0.9rem;
        display:flex;
        align-items:center;
        justify-content:center;
    }
    .new-chat-btn:hover {background:rgba(43, 108, 83, 0.6);}
    .sidebar-header {
        display:flex;
        align-items:center;
        justify-content:space-between;
        margin-bottom:1rem;
    }
    .sidebar-toggle {
        display:none; /* Hidden on desktop */
        background: transparent;
        border:none;
        color:white;
        cursor:pointer;
        font-size:1.5rem;
    }
    .profile-info {
        display:flex;
        align-items:center;
        gap:0.75rem;
    }
    .profile-avatar {
        width:40px;
        height:40px;
        background-color:var(--primary-500);
        border-radius:50%;
        display:flex;
        align-items:center;
        justify-content:center;
        font-weight:700;
    }
    .profile-name {
        font-weight:600;
    }
    .auth-actions {
        display:flex;
        gap:1rem;
        margin-top:auto;
        padding-top:1rem;
        border-top:1px solid var(--glass-dark-border);
    }
    .auth-btn {
        flex:1;
        padding:0.75rem;
        border-radius:var(--radius);
        font-weight:600;
        cursor:pointer;
        border:none;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .login-btn {background-color: var(--primary-500); color:white;}
    .login-btn:hover {transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1);}
    .logout-btn {background-color: #ef4444; color:white;}
    .logout-btn:hover {transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1);}

    /* Main Chat Content */
    .chat-container {
        flex:1;
        display:flex;
        flex-direction:column;
        overflow:hidden;
        padding:1rem;
        position:relative;
    }
    .chat-header {
        display:flex;
        justify-content:flex-start;
        align-items:center;
        padding:1rem;
        border-bottom:1px solid var(--glass-dark-border);
    }
    .chat-header h1 {
        font-size:1.5rem;
        font-weight:600;
        color:white;
    }
    .message-container {
        flex:1;
        overflow-y:auto;
        padding:1rem 2rem;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* Internet Explorer 10+ */
    }
    .message-container::-webkit-scrollbar {
        width: 0px;  /* Safari and Chrome */
    }
    .message {
        display:flex;
        margin-bottom:1.5rem;
        animation: fadeIn 0.5s ease-out;
    }
    .message.ai {justify-content:flex-start;}
    .message.user {justify-content:flex-end;}
    .message-content {
        display:flex;
        align-items:flex-start;
        gap:0.75rem;
        max-width:80%;
    }
    .message.user .message-content {flex-direction:row-reverse;}
    .message-avatar {
        width:40px;
        height:40px;
        border-radius:50%;
        background-color: #64748b;
        color:white;
        display:flex;
        align-items:center;
        justify-content:center;
        font-weight:600;
        flex-shrink:0;
    }
    .message-avatar.ai-avatar {background-color:var(--primary-500);}
    .message-bubble {
        padding:1rem;
        border-radius:1.5rem;
        background-color:#1e293b;
        color:white;
        box-shadow:0 4px 6px rgba(0,0,0,0.1);
        border:1px solid rgba(255,255,255,0.1);
        position:relative;
    }
    .message-bubble.ai {
        border-top-left-radius:0.5rem;
        background-color:#0f172a;
    }
    .message-bubble.user {
        border-top-right-radius:0.5rem;
        background-color:rgba(255,255,255,0.1);
    }
    .message-text {
        font-size:1rem;
        line-height:1.5;
    }

    /* Input Form */
    .input-form-container {
        padding:1rem;
        background-color:var(--glass-dark-bg);
        border-top:1px solid var(--glass-dark-border);
    }
    .input-form {
        display:flex;
        width:100%;
        max-width:900px;
        margin:0 auto;
        gap:0.5rem;
    }
    .message-input {
        flex:1;
        background-color:rgba(255,255,255,0.1);
        border:1px solid rgba(255,255,255,0.2);
        border-radius:var(--radius);
        padding:1rem;
        font-size:1rem;
        color:white;
        resize:none;
        outline:none;
        transition:border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .message-input:focus {
        border-color:var(--primary-500);
        box-shadow:0 0 0 3px rgba(60, 255, 142, 0.3);
    }
    .send-btn {
        background-color:var(--primary-500);
        color:white;
        border:none;
        border-radius:var(--radius);
        padding:0 1.5rem;
        cursor:pointer;
        transition:background-color 0.2s ease, transform 0.2s ease;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:1.5rem;
    }
    .send-btn:hover {
        background-color:var(--emerald-500);
        transform:scale(1.05);
    }
    .send-btn:disabled {
        background-color:#334155;
        cursor:not-allowed;
    }

    /* Animations */
    @keyframes fadeIn {
        from {opacity:0;transform:translateY(10px);}
        to {opacity:1;transform:translateY(0);}
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .main-layout {flex-direction:column;}
        .sidebar {
            position:absolute;
            height:100%;
            z-index:10;
        }
        .sidebar-toggle {display:block;}
        .chat-header {
            border-bottom:none;
            padding-top:2rem;
        }
        .message-container {padding:1rem 1.5rem;}
        .message-bubble {padding:0.75rem;}
        .message-input {padding:0.75rem;}
        .input-form {
            max-width:100%;
            padding:0 1rem;
        }
    }
</style>
</head>
<body>
<div id="app">
    <div class="background-gradient"></div>
    <div class="background-overlay"></div>

    <div class="main-layout">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span class="profile-info">
                    <span class="profile-avatar" id="user-avatar">?</span>
                    <span class="profile-name" id="user-name">Guest</span>
                </span>
                <button class="sidebar-toggle" id="sidebar-toggle">â˜°</button>
            </div>

            <button class="new-chat-btn" id="new-chat-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                New Chat
            </button>
            <div class="chat-history" id="chat-history">
                <!-- Chat history items will be dynamically added here -->
            </div>
            
            <div class="auth-actions" id="auth-actions">
                <button class="auth-btn login-btn" onclick="window.location.href='/google-login'">Sign In with Google</button>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-container">
            <div class="chat-header">
                <button class="sidebar-toggle" id="sidebar-toggle-main">â˜°</button>
                <h1>Welcome to EchooAI</h1>
            </div>
            <div class="message-container" id="message-container">
                <!-- Chat messages will be dynamically added here -->
            </div>
            <div class="input-form-container">
                <form id="chat-form" class="input-form">
                    <textarea id="message-input" class="message-input" placeholder="Type a message..." rows="1"></textarea>
                    <button type="submit" class="send-btn" id="send-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send-horizontal"><path d="m3 3 3 9-3 9 19-9Z"/><path d="M6 12h16"/></svg>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script type="module">
    // Firebase SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, getDoc, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables from the Canvas environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app, db, auth;
    let userId;
    let currentChatId = null;

    const messageContainer = document.getElementById('message-container');
    const inputForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const chatHistoryEl = document.getElementById('chat-history');
    const newChatBtn = document.getElementById('new-chat-btn');
    const authActionsEl = document.getElementById('auth-actions');
    const userAvatarEl = document.getElementById('user-avatar');
    const userNameEl = document.getElementById('user-name');
    const sidebarEl = document.getElementById('sidebar');
    const sidebarToggleMainBtn = document.getElementById('sidebar-toggle-main');

    // --- Firebase Initialization and Authentication ---
    async function initializeFirebase() {
        try {
            // Initialize Firebase services
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Listen for authentication state changes
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userNameEl.textContent = user.displayName || 'User';
                    userAvatarEl.textContent = user.displayName ? user.displayName[0].toUpperCase() : 'U';
                    authActionsEl.innerHTML = `<button class="auth-btn logout-btn" onclick="window.location.href='/logout'">Sign Out</button>`;
                    
                    // After successful login, start listening to chat history
                    loadChatHistory();
                    
                    // Check if a chat ID is in the URL and load it
                    const urlParams = new URLSearchParams(window.location.search);
                    const chatIdFromUrl = urlParams.get('chat_id');
                    if (chatIdFromUrl) {
                        currentChatId = chatIdFromUrl;
                        loadChat(currentChatId);
                    }
                } else {
                    userId = null;
                    userNameEl.textContent = 'Guest';
                    userAvatarEl.textContent = '?';
                    authActionsEl.innerHTML = `<button class="auth-btn login-btn" onclick="window.location.href='/google-login'">Sign In with Google</button>`;
                    chatHistoryEl.innerHTML = '';
                    
                    // Handle the initial sign-in for the Canvas environment
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (error) {
                            console.error("Custom token sign-in failed:", error);
                            // Fallback to anonymous sign-in if custom token fails
                            await signInAnonymously(auth);
                        }
                    } else {
                        // For other cases, sign in anonymously
                        await signInAnonymously(auth);
                    }
                }
            });
        } catch (e) {
            console.error("Error initializing Firebase:", e);
        }
    }

    // --- Chat History Functions ---
    function loadChatHistory() {
        if (!userId) {
            return;
        }
        const userChatsRef = collection(db, 'users', userId, 'chats');
        
        // Listen for real-time updates using onSnapshot
        onSnapshot(userChatsRef, (snapshot) => {
            chatHistoryEl.innerHTML = '';
            snapshot.forEach((doc) => {
                const chatData = doc.data();
                const chatItem = document.createElement('div');
                chatItem.className = `chat-item ${doc.id === currentChatId ? 'active' : ''}`;
                chatItem.dataset.chatId = doc.id;
                chatItem.innerHTML = `<span class="chat-item-text">${chatData.title || 'Untitled Chat'}</span>`;
                chatItem.addEventListener('click', () => {
                    if (currentChatId !== doc.id) {
                        loadChat(doc.id);
                    }
                });
                chatHistoryEl.appendChild(chatItem);
            });
        }, (error) => {
            console.error("Error fetching chat history:", error);
        });
    }

    async function loadChat(chatId) {
        if (!userId || !chatId) {
            return;
        }
        
        currentChatId = chatId;
        
        // Update active class on sidebar items
        document.querySelectorAll('.chat-item').forEach(item => {
            item.classList.remove('active');
            if (item.dataset.chatId === chatId) {
                item.classList.add('active');
            }
        });
        
        try {
            const chatDocRef = doc(db, 'users', userId, 'chats', chatId);
            const chatDoc = await getDoc(chatDocRef);
            
            if (chatDoc.exists()) {
                const history = chatDoc.data().history;
                messageContainer.innerHTML = '';
                history.forEach(message => {
                    displayMessage(message.content, message.role);
                });
                messageContainer.scrollTop = messageContainer.scrollHeight;
            } else {
                console.error("Chat document not found.");
            }
        } catch(e) {
            console.error("Error loading chat:", e);
        }
    }
    
    // --- UI and Message Display Functions ---
    function displayMessage(text, sender) {
        const messageEl = document.createElement('div');
        messageEl.className = `message ${sender}`;
        const avatar = sender === 'ai' ? `<div class="message-avatar ai-avatar">AI</div>` : `<div class="message-avatar">You</div>`;
        const bubbleClass = sender === 'ai' ? 'ai' : 'user';
        const content = sender === 'ai' ? text.replace(/\n/g, '<br>') : text;
        messageEl.innerHTML = `
            <div class="message-content">
                ${sender === 'ai' ? avatar : ''}
                <div class="message-bubble ${bubbleClass}">
                    <div class="message-text">${content}</div>
                </div>
                ${sender === 'user' ? avatar : ''}
            </div>
        `;
        messageContainer.appendChild(messageEl);
        messageContainer.scrollTop = messageContainer.scrollHeight;
    }

    async function sendMessage(text) {
        if (!text.trim()) return;

        displayMessage(text, 'user');
        messageInput.value = '';
        sendBtn.disabled = true;

        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            });
            const data = await response.json();
            const aiText = data.reply;

            displayMessage(aiText, 'ai');
            
            // Auto-save the chat history
            await saveChat();
            
        } catch (error) {
            console.error('Error contacting AI server:', error);
            displayMessage('Error contacting AI server.', 'ai');
        } finally {
            sendBtn.disabled = false;
        }
    }
    
    async function newChat() {
        try {
            await fetch('/new-chat', { method: 'POST' });
            messageContainer.innerHTML = '';
            currentChatId = null;
            document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
        } catch (e) {
            console.error("Error starting new chat:", e);
        }
    }
    
    async function saveChat() {
        try {
            const response = await fetch('/save-chat', { method: 'POST' });
            const data = await response.json();
            if (data.success && data.chat_id) {
                currentChatId = data.chat_id;
            }
        } catch(e) {
            console.error("Error saving chat:", e);
        }
    }

    // --- Event Listeners ---
    inputForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = messageInput.value.trim();
        if (text) {
            await sendMessage(text);
        }
    });

    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            inputForm.dispatchEvent(new Event('submit'));
        }
    });

    messageInput.addEventListener('input', () => {
        messageInput.style.height = 'auto';
        messageInput.style.height = messageInput.scrollHeight + 'px';
    });

    newChatBtn.addEventListener('click', newChat);

    sidebarToggleMainBtn.addEventListener('click', () => {
        sidebarEl.classList.toggle('hidden');
    });

    // Initial load
    initializeFirebase();

</script>
</body>
</html>
