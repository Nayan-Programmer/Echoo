!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EchooAI ‚Äî Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --glass: rgba(255,255,255,.06); --glass2: rgba(255,255,255,.08); }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .glass { background: var(--glass); backdrop-filter: blur(10px); }
    .msg a { text-decoration: underline; }
    .msg code { background: rgba(0,0,0,.35); padding: .15rem .35rem; border-radius: .35rem; }
    .typing span { animation: blink 1.2s infinite; }
    .typing span:nth-child(2){ animation-delay: .15s }
    .typing span:nth-child(3){ animation-delay: .3s }
    @keyframes blink { 0%, 80%, 100% { opacity: .2 } 40% { opacity: 1 } }
  </style>
</head>
<body class="bg-neutral-950 text-neutral-100 min-h-screen">
  <!-- Top Nav -->
  <header class="sticky top-0 z-30 border-b border-white/10 bg-neutral-950/70 backdrop-blur">
    <div class="mx-auto max-w-6xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-2xl bg-gradient-to-tr from-cyan-500 via-blue-500 to-indigo-500 grid place-items-center shadow-lg shadow-cyan-500/20">
          <span class="font-black">E</span>
        </div>
        <div>
          <h1 class="text-lg font-bold leading-tight">EchooAI</h1>
          <p class="text-xs text-neutral-400 -mt-0.5">Groq + Google + Math</p>
        </div>
        <span id="onlineDot" class="ml-2 inline-flex items-center gap-1 rounded-full bg-emerald-500/15 px-2 py-0.5 text-emerald-300 text-[11px]">
          <span class="h-1.5 w-1.5 rounded-full bg-emerald-400 animate-pulse"></span> live
        </span>
      </div>

      <div class="flex items-center gap-2">
        <button id="openSearch" class="rounded-xl px-3 py-2 text-sm glass hover:bg-white/10 transition flex items-center gap-2">
          <i data-lucide="search" class="h-4 w-4"></i>
          Web Search
        </button>
        <button id="themeBtn" class="rounded-xl px-3 py-2 text-sm glass hover:bg-white/10 transition flex items-center gap-2">
          <i data-lucide="sun" class="h-4 w-4"></i>
          Theme
        </button>
        <button id="profileBtn" class="rounded-xl px-3 py-2 text-sm bg-cyan-500 hover:bg-cyan-600 text-white transition flex items-center gap-2">
          <i data-lucide="user" class="h-4 w-4"></i>
          Profile
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="mx-auto max-w-6xl px-4 grid lg:grid-cols-[280px,1fr] gap-4 lg:gap-6 py-6">
    <!-- Sidebar -->
    <aside class="hidden lg:block glass rounded-2xl p-4 border border-white/10 h-fit sticky top-20">
      <h2 class="text-sm font-semibold mb-3">Quick Actions</h2>
      <div class="grid gap-2 text-sm">
        <button class="quick glass hover:bg-white/10 rounded-xl px-3 py-2 text-left" data-fill="search: latest tech news India">üì∞ Search latest tech</button>
        <button class="quick glass hover:bg-white/10 rounded-xl px-3 py-2 text-left" data-fill="integrate(x^2, x)">‚à´ Integrate x^2</button>
        <button class="quick glass hover:bg-white/10 rounded-xl px-3 py-2 text-left" data-fill="solve(x^2 - 5*x + 6, x)">üßÆ Solve quadratic</button>
        <button class="quick glass hover:bg-white/10 rounded-xl px-3 py-2 text-left" data-fill="Explain black holes in simple words">üï≥Ô∏è Explain black holes</button>
      </div>

      <h2 class="text-sm font-semibold mt-6 mb-3">Hints</h2>
      <ul class="text-xs text-neutral-400 space-y-2 list-disc list-inside">
        <li>Prefix <code>search:</code> to use Google.</li>
        <li>Type equations to trigger Math mode.</li>
        <li>Normal text ‚Üí Groq LLM replies.</li>
      </ul>
    </aside>

    <!-- Chat Column -->
    <section class="glass rounded-2xl border border-white/10 min-h-[70vh] grid grid-rows-[1fr,auto]">
      <!-- Messages -->
      <div id="chatBox" class="overflow-y-auto p-4 space-y-3">
        <!-- Welcome card -->
        <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
          <div class="flex items-center gap-2 text-neutral-300 text-sm">
            <i data-lucide="sparkles" class="h-4 w-4"></i>
            <span>Welcome! Ask anything. Use <code>search:</code> for web, write equations for math.</span>
          </div>
        </div>
      </div>

      <!-- Composer -->
      <div class="border-t border-white/10 p-3">
        <div class="flex items-end gap-2">
          <textarea id="userInput" rows="1" placeholder="Type your message..." class="flex-1 max-h-40 resize-none rounded-xl bg-white/5 border border-white/10 px-4 py-3 outline-none focus:ring-2 focus:ring-cyan-500/40"></textarea>
          <button id="sendBtn" class="rounded-xl px-4 py-3 bg-cyan-500 hover:bg-cyan-600 text-white font-medium flex items-center gap-2">
            <i data-lucide="send" class="h-4 w-4"></i>
            Send
          </button>
        </div>
        <div class="flex items-center justify-between mt-2 text-[12px] text-neutral-400">
          <div class="flex gap-2">
            <span class="inline-flex items-center gap-1 rounded-full bg-white/5 border border-white/10 px-2 py-0.5">Groq LLM</span>
            <span class="inline-flex items-center gap-1 rounded-full bg-white/5 border border-white/10 px-2 py-0.5">Google Search</span>
            <span class="inline-flex items-center gap-1 rounded-full bg-white/5 border border-white/10 px-2 py-0.5">Sympy Math</span>
          </div>
          <button id="clearBtn" class="hover:underline">Clear</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Web Search Drawer -->
  <div id="searchDrawer" class="fixed inset-0 hidden">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="absolute right-0 top-0 h-full w-full sm:w-[520px] bg-neutral-950 border-l border-white/10 p-4 overflow-y-auto">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold">Google Custom Search</h3>
        <button id="closeSearch" class="rounded-lg px-2 py-1 glass hover:bg-white/10"><i data-lucide="x" class="h-4 w-4"></i></button>
      </div>
      <div class="text-xs text-neutral-400 mb-2">Type queries here; results appear inside the panel.</div>
      <!-- Replace cx value with your CSE ID if different -->
      <script async src="https://cse.google.com/cse.js?cx=c04a4922b8ef14b65"></script>
      <div class="gcse-search"></div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="fixed inset-0 hidden">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[92vw] max-w-md glass rounded-2xl border border-white/10 p-5">
      <h3 class="text-lg font-bold mb-1">Set your name</h3>
      <p class="text-sm text-neutral-400 mb-4">This will personalize the chat. Stored only in your browser.</p>
      <input id="nameInput" class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2 outline-none focus:ring-2 focus:ring-cyan-500/40" placeholder="Your name" />
      <div class="mt-4 flex justify-end gap-2">
        <button id="cancelProfile" class="px-3 py-2 rounded-xl glass hover:bg-white/10">Cancel</button>
        <button id="saveProfile" class="px-3 py-2 rounded-xl bg-cyan-500 hover:bg-cyan-600 text-white">Save</button>
      </div>
    </div>
  </div>

  <script>
    // Icons
    window.addEventListener('DOMContentLoaded', () => { lucide.createIcons(); });

    const chatBox = document.getElementById('chatBox');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const themeBtn = document.getElementById('themeBtn');
    const openSearch = document.getElementById('openSearch');
    const searchDrawer = document.getElementById('searchDrawer');
    const closeSearch = document.getElementById('closeSearch');
    const profileBtn = document.getElementById('profileBtn');
    const profileModal = document.getElementById('profileModal');
    const nameInput = document.getElementById('nameInput');
    const cancelProfile = document.getElementById('cancelProfile');
    const saveProfile = document.getElementById('saveProfile');

    // Local username
    const USERNAME_KEY = 'echoo_username';
    function getUser(){ return localStorage.getItem(USERNAME_KEY) || 'User'; }
    function setUser(v){ localStorage.setItem(USERNAME_KEY, v); }

    // Utilities
    function escapeHtml(str){ const div = document.createElement('div'); div.innerText = str; return div.innerHTML; }

    function addMsg(html, who = 'ai'){
      const wrap = document.createElement('div');
      wrap.className = 'msg group';
      const isUser = who === 'user';
      wrap.innerHTML = `
        <div class="flex items-start gap-3 ${isUser? 'justify-end' : ''}">
          ${isUser ? '' : '<div class="h-8 w-8 rounded-xl bg-cyan-500/20 grid place-items-center text-cyan-300">E</div>'}
          <div class="max-w-[85%] md:max-w-[70%] ${isUser? 'bg-cyan-600 text-white' : 'bg-white/5 text-neutral-100'} border border-white/10 rounded-2xl px-4 py-3 leading-relaxed">
            <div class="prose prose-invert prose-sm max-w-none">${html}</div>
            <div class="mt-2 hidden group-hover:flex items-center gap-2 text-[10px] opacity-70">
              <button class="copyBtn hover:underline">Copy</button>
            </div>
          </div>
          ${isUser ? '<div class="h-8 w-8 rounded-xl bg-white/10 grid place-items-center">üë§</div>' : ''}
        </div>`;
      chatBox.appendChild(wrap);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function addTyping(){
      const el = document.createElement('div');
      el.id = 'typing';
      el.className = 'flex items-start gap-3';
      el.innerHTML = `
        <div class="h-8 w-8 rounded-xl bg-cyan-500/20 grid place-items-center text-cyan-300">E</div>
        <div class="bg-white/5 border border-white/10 rounded-2xl px-4 py-3">
          <div class="typing"><span>‚Ä¢</span> <span>‚Ä¢</span> <span>‚Ä¢</span></div>
        </div>`;
      chatBox.appendChild(el);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function removeTyping(){ const el = document.getElementById('typing'); if(el) el.remove(); }

    // Send flow
    async function send(){
      const text = userInput.value.trim();
      if(!text) return;
      const prefix = getUser();
      addMsg(escapeHtml(prefix + ': ' + text), 'user');
      userInput.value = '';

      addTyping();
      try{
        const res = await fetch('/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: text }) });
        const data = await res.json();
        removeTyping();

        const html = marked.parse(String(data.reply || '')); // markdown render
        addMsg(html, 'ai');
        lucide.createIcons();
      }catch(e){
        removeTyping();
        addMsg('Error contacting the server.', 'ai');
      }
    }

    sendBtn.addEventListener('click', send);
    userInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); send(); }
      // autoresize
      userInput.style.height = 'auto';
      userInput.style.height = Math.min(userInput.scrollHeight, 160) + 'px';
    });

    // Copy buttons (event delegation)
    chatBox.addEventListener('click', (e)=>{
      const btn = e.target.closest('.copyBtn');
      if(!btn) return;
      const bubble = btn.closest('.msg').querySelector('.prose');
      const text = bubble.innerText;
      navigator.clipboard.writeText(text).then(()=>{ btn.textContent = 'Copied!'; setTimeout(()=>btn.textContent='Copy',1200); });
    });

    // Clear chat
    clearBtn.addEventListener('click', ()=>{ chatBox.innerHTML = ''; });

    // Theme toggle (light/dark)
    let dark = true;
    function applyTheme(){ document.body.classList.toggle('bg-white', !dark); document.body.classList.toggle('text-neutral-900', !dark); }
    themeBtn.addEventListener('click', ()=>{ dark = !dark; applyTheme(); });

    // Drawer controls
    openSearch.addEventListener('click', ()=>{ searchDrawer.classList.remove('hidden'); });
    closeSearch.addEventListener('click', ()=>{ searchDrawer.classList.add('hidden'); });

    // Quick fill buttons
    document.querySelectorAll('.quick').forEach(btn=>{
      btn.addEventListener('click', ()=>{ userInput.value = btn.dataset.fill; userInput.focus(); });
    });

    // Profile modal
    profileBtn.addEventListener('click', ()=>{
      nameInput.value = getUser();
      profileModal.classList.remove('hidden');
    });
    cancelProfile.addEventListener('click', ()=> profileModal.classList.add('hidden'));
    saveProfile.addEventListener('click', ()=>{
      const v = nameInput.value.trim() || 'User';
      setUser(v);
      profileModal.classList.add('hidden');
    });

    // Open profile on first visit
    if(!localStorage.getItem('echoo_username')){
      setTimeout(()=>profileBtn.click(), 600);
    }
  </script>
</body>
</html>
